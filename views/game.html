<!DOCTYPE HTML>
<html>
	<head>
		<title>ROAD</title>
		<link rel="stylesheet" type="text/css" href="../public/stylesheets/style.css">
	</head>
	

	</style>
	<body>
		<!--Audio File Declaration-->
		<audio id="crash" src="../public/music/crash.mp3" type="audio/mpeg"></audio>

		<canvas id="progress" width="500" height="40"></canvas>
		<canvas id="canvas" width="500" height="600"></canvas>
		
	</body>
	<!--Socket Script-->
		<script src="../socket.io/socket.io.js"></script>
	<script>
		var canvas = document.getElementById('canvas');//canvas for road
		var ctx = canvas.getContext('2d');
		var canvas1 = document.getElementById('progress');//canvas for progress
		var ctx1 = canvas1.getContext('2d');
		var carImage = new Image();//creating object for car image
		carImage.src = '../public/images/car.png';
		carImage.onload = gamePlay;
		var barricadeImage = new Image();//creating object for barricade image
		barricadeImage.src = '../public/images/barricade.png';
		var flag = 0;// flag for checking collision
		var lives = 5;
		var gameover = new Image();//creating object for gameover
		gameover.src = '../public/images/gameover.png';
		var endflag = 1;
		var crash = document.getElementById('crash');//fetching crash sound
		
		document.addEventListener('keydown', update);
		//function to declare properties of objects
		function object(x, y, status, width, height, speed) {
			this.x = x;
			this.y = y;
			this.status = status;
			this.height = height;
			this.width = width;
			this.speed = speed;
		}
		//creating obstacle and car images as objects
		var obstacle = new object(40, 0, true, 80, 80, 5);
		var car = new object(30, 420, true, 100, 150, 20);
		//function draws the whitelines on the road canvas
		function drawWhiteLines(x) {
			ctx.beginPath();
			ctx.moveTo(x, 0);
			ctx.lineTo(x, 600);
			ctx.lineWidth = 10;
			ctx.strokeStyle = 'white';
			ctx.stroke();
			ctx.closePath()
		}
		//draws the car image
		function drawCar() {
			ctx.drawImage(carImage, car.x, car.y);
		}
		//draws the obstacle image
		function drawObstacle() {
			if (endflag == 1)
				ctx.drawImage(barricadeImage, 0, 0, 150, 150, obstacle.x, obstacle.y, obstacle.width, obstacle.height);
		}
	     //functions changes the color and decreases the width of progress bar as lives decrease
     	function progressBar() {
  			var bar = document.getElementById('progress');
   			var color = 'green';
	   		var barWidth;
	   		bar.style.height = '40px';
			barWidth = (lives / 5) * 500;
	   		bar.style.width = barWidth + 'px';
	   		if (lives <= 1) {
	    		color = 'red';
	   		} else if (lives <= 3) {
	    		color = 'yellow';
	   		}
	   		bar.style.background = color;
	   		if ( barWidth == 0)
	   			canvas1.style.display = "none";

	  	}
		//function detects collision by checking the collision conditions
		function detectCollision() {
			if (car.y <= obstacle.y + obstacle.height) {
				if (flag == 0 
					&& (car.x + car.width >= obstacle.x && car.x + car.width <= obstacle.x + obstacle.width)
					|| (car.x >= obstacle.x && car.x <= obstacle.x + obstacle.width)
					|| (car.x <= obstacle.x && obstacle.x + obstacle.width <= car.width + car.x)) {
					flag = 1;
					obstacle.y = 601;
					lives--;
					crash.play();
				}
			}
		}
		//Function to change lane through the accelerometer values
		function changeLane(direction){
		  	direction = Number(direction.toFixed(0)); //Direction from accelerometer 
		 	var offset = car.width;
		 	// Direction is negative for left and positive for right
		 	if (direction < 0)
		   		offset = 0;
		  	car.x = (canvas.width/15)*direction + canvas.width/2 - offset;
		}

		function gamePlay() {
			progressBar();
			ctx1.clearRect(0, 0, canvas1.width, canvas1.height);
			ctx.clearRect(0, 0, canvas.width, canvas.height);
			drawWhiteLines(160);
			drawWhiteLines(330);
			drawCar();
			detectCollision();
			//to display "GAME OVER"
			if (lives == 0) {
				endflag=0;
				ctx.drawImage(gameover, 130, 80, 250, 180);
				ctx.beginPath();
				ctx.rect(130, 260, 250, 100);
				ctx.fill();
				ctx.font = 'bold 25px serif';
				ctx.fillStyle = 'green';
				ctx.fillText('Press Enter to Start', 153, 280);
			    ctx.fillStyle="black";
			    ctx.closePath();
			}

			if (flag == 1 && lives != 0) {
				flag = 0;
				obstacle.x = 30 + Math.round(Math.random() * 2) * 170;
				obstacle.y = 0;
			}

			if (obstacle.y >= canvas.height) {
				obstacle.y = 0;
				obstacle.x = 30 + Math.round(Math.random() * 2) * 170;
			} else {
				obstacle.y += obstacle.speed;
			}
			
			drawObstacle();	
			requestAnimationFrame(gamePlay);
		}

		function update(event) {
			if (event.keyCode == 37 && endflag == 1) {
					if ((car.x - 150 >= 0) && (car.x <= canvas.width - carImage.width))
		        		car.x -= 170; 		
			}

			if (event.keyCode == 39 && endflag == 1) {
				if ((car.x >= 0) && (car.x + 150 <= canvas.width - carImage.width))
			    	car.x += 170;		
			}
			if(event.keyCode == 13 && endflag == 0){
					endflag = 1;
					window.location.reload();
			}
				}
		
		var socket = io();
		socket.on('serverEvent', function(data){
			//Lower and upper bound for accelerometer values
		    if(data>7.5){
		    	data = 7.5;
		    }
		    else if(Math.abs(data)>7.5){
		    	data = -7.5;
		    }
		    changeLane(-1*Number(data));// To change lane
		});

	</script>
</html>